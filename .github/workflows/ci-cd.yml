name: CI-CD Pipeline

on:
  push:
    branches:
      - master
      - pre-release/**
      - release/**

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_FE: myorg/frontend
  IMAGE_NAME_BE: myorg/backend

jobs:
  build-test-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set short SHA
        run: echo "SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Determine environment
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/master" ]]; then
            echo "ENV=dev" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF}" == refs/heads/pre-release/* ]]; then
            echo "ENV=preprod" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF}" == refs/heads/release/* ]]; then
            echo "ENV=release" >> $GITHUB_ENV
          fi

      # ---------- Frontend ----------
      - name: Install frontend deps
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      # ---------- Backend ----------
      - name: Install backend deps
        run: |
          cd backend
          npm ci

      - name: Test backend
        run: |
          cd backend
          npm test

      # ---------- Docker ----------
      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push Frontend Image
        run: |
          docker build -t $REGISTRY/${IMAGE_NAME_FE}:${ENV}-${SHA} frontend
          docker push $REGISTRY/${IMAGE_NAME_FE}:${ENV}-${SHA}

      - name: Build & Push Backend Image
        run: |
          docker build -t $REGISTRY/${IMAGE_NAME_BE}:${ENV}-${SHA} backend
          docker push $REGISTRY/${IMAGE_NAME_BE}:${ENV}-${SHA}

      # ---------- Deploy ----------
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/frontend frontend=$REGISTRY/${IMAGE_NAME_FE}:${ENV}-${SHA} -n ${ENV}
          kubectl set image deployment/backend backend=$REGISTRY/${IMAGE_NAME_BE}:${ENV}-${SHA} -n ${ENV}
